{% extends 'base.html' %}

{% block content %}
    {% if messages %}
        {% for message in messages %}
                <div class="alert alert-success alert-dismissible" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    {{ message }} {{msg.level_tag}}
                </div>
        {% endfor %}
    {% endif %}

<div class="row">
        <form class="form-horizontal" role="form" action="{% url 'facturacion:index' %}" method="POST">{% csrf_token %}
            <div class="col-md-6">
            <section class="panel">
                <header class="panel-heading">
                    Cliente
                </header>
                <div class="panel-body" >
                     <div class="form-group">
                                  {{ cliente_form.dni.errors }}
                                  <label for="{{ cliente_form.dni.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.dni.label }}</label>
                                  <div class="col-lg-10">
                                      <input class="form-control" type="text" id="BuscarCliente" placeholder="D.N.I." maxlength="8" onkeyup="search_client()" name="BuscarCliente">
                                  </div>
                              </div>
                            <table class="table table-bordered">
                                <tbody><tr>
                                    <th style="width: 100px" >Foto</th>
                                    <th>Nombre</th>
                                    <th>Telefono</th>
                                    <th style="width: 40px">Email</th>
                                </tr>
                                <tr>
                                    <td id="cliente_foto"></td>
                                    <td id="cliente_nombre"></td>
                                    <td id="cliente_telefono"></td>
                                    <td><span class="badge bg-red" id="cliente_email"></span></td>
                                </tr></tbody>
                            </table>
                            <button data-toggle="modal" data-target="#cliente-form" class="btn btn-primary btn-large" id="add_cliente">AÃ±adir Cliente</button>
                </div>
            </section>
        </div>
        <div class="col-lg-6">
            <!--chat start-->
            <section class="panel">
                <header class="panel-heading">
                    Ventas
                </header>
                <div class="panel-body" >
                          <div class="form-group">

                              <div class="col-lg-4 col-sm-2 control-label"><strong>{{ venta_form.nro.label }}</strong></div>
                              <div class="col-lg-8">
                                  {{ venta_form.nro.errors }}
                                  {{ venta_form.nro }}
                              </div>
                          </div>
                          <div class="form-group">
                              <div class="col-lg-4 col-sm-2 control-label"><strong>{{ venta_form.observaciones.label }}</strong></div>
                              <div class="col-lg-8">
                                {{ venta_form.observaciones.errors }}
                                {{ venta_form.observaciones }}
                              </div>
                          </div>
                </div>
            </section>
        </div>
        <div class="col-lg-12">
        <section class="panel">
            <header class="panel-heading">
                Detalles
            </header>
            <div class="panel-body">
                        <div id="form">
                            {% for form in DetalleFormSet %}
                            <div class="formset">
                                <div class=" col-sm-4 col-xs-12">
                                    <div class="form-group ">
                                        <div class="no-padding-top form-field col-sm-11">
                                            {{ form.codigo_producto.errors }}
                                            <div class="input-group">
                                                <span class="input-group-addon glyphicon glyphicon-plus-sign " ></span>
                                                {{ form.codigo_producto}}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-4 col-xs-12">

                                    <div class="form-group ">
                                        <div class="no-padding-top form-field col-sm-11">
                                            {{ form.precio.errors }}
                                            <div class="input-group">
                                                <span class="input-group-addon glyphicon glyphicon-usd " ></span>
                                                {{ form.precio}}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                               <div class="col-sm-4 col-xs-12">
                                    <div class="form-group ">
                                        <div class="no-padding-top form-field col-sm-11">
                                            {{ form.cantidad.errors }}
                                            <div class="input-group">
                                                <span class="input-group-addon glyphicon glyphicon-asterisk " ></span>
                                                {{ form.cantidad}}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            {% endfor %}

                        </div>
                    {{ DetalleFormSet.management_form }}
                </div>
            </section>
        </div>
        <div class="col-lg-12">
            <input id="RegistrarVenta" type="submit" value="Registrar Venta"/>
        </div>
        </form>

</div>
<!-- Modal -->
    <div id="cliente-form" class="modal fade" role="dialog">
          <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Registrar Cliente</h4>
              </div>
              <form id="client-form" class="form-horizontal" role="form" action="{% url 'cliente:GuardarCliente' %}" method="POST" enctype="multipart/form-data">
              <div class="modal-body">
                  <div class="alert alert-warning" id="msg"></div>

                      {% csrf_token %}
                      <div class="form-group">
                          {{ cliente_form.dni.errors }}
                          <label for="{{ cliente_form.dni.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.dni.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.dni }}
                          </div>
                      </div>
                      <div class="form-group">
                          {{ cliente_form.nombre.errors }}
                          <label for="{{ cliente_form.nombre.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.nombre.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.nombre }}
                          </div>
                      </div>
                      <div class="form-group">
                          {{ cliente_form.apellido.errors }}
                          <label for="{{ cliente_form.apellido.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.apellido.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.apellido }}
                          </div>
                      </div>
                      <div class="form-group">
                          {{ cliente_form.direccion.errors }}
                          <label for="{{ cliente_form.direccion.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.direccion.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.direccion }}
                          </div>
                      </div>
                      <div class="form-group">
{#                          <div class="alert alert-warning" role="alert">...</div>#}
                          {{ cliente_form.telefono.errors }}
                          <label for="{{ cliente_form.telefono.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.telefono.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.telefono }}
                          </div>
                      </div>
                      <div class="form-group">
{#                          <div class="alert alert-warning" role="alert">...</div>#}
                          {{ cliente_form.email.errors }}
                          <label for="{{ cliente_form.email.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.email.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.email }}
                          </div>
                      </div>
                      <div class="form-group">
                          {{ cliente_form.ocupacion.errors }}
                          <label for="{{ cliente_form.ocupacion.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.ocupacion.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.ocupacion }}
                          </div>
                      </div>
                      <div class="form-group">
                          {{ cliente_form.foto.errors }}
                          <label for="{{ cliente_form.foto.auto_id }}" class="col-lg-2 col-sm-2 control-label">{{ cliente_form.foto.label }}</label>
                          <div class="col-lg-10">
                              {{ cliente_form.foto }}
                          </div>
                      </div>

                  </div>
                  <div class="modal-footer">
                    <input class="btn btn-success" type="submit" value="AÃ±adir" id="submit_cliente">
                    <a href="#" class="btn" data-dismiss="modal">Cancelar</a>
                  </div>
                  </form>
            </div>
          </div>
    </div>
<!-- endmodal -->
{% endblock %}
{% block application_javascript %}
    <script type="application/javascript">
            //Buscar Cliente
            function search_client(){
                $.ajax({
                    url: "/cliente/buscar-cliente/" +  $("#BuscarCliente").val(),
                    type: "GET",
                    dataType: "json",
                    async: true,
                    success: function (j) {
                        for(var i = 0; i< j.length; i++)
                        {
                            $('#cliente_foto').html(j[i]['foto']);
                            $('#cliente_nombre').html(j[i]['nombre']);
                            $('#cliente_telefono').html(j[i]['telefono']);
                            $('#cliente_email').html(j[i]['email']);
                            $('#add_cliente').attr('disabled',true);
                        }
                    },
                    error: function (xhr, errmsg, err) {
                            $('#cliente_foto').html('No existe');
                            $('#cliente_nombre').html('Cliente no encontrado');
                            $('#cliente_telefono').html('No existe');
                            $('#cliente_email').html('No existe');
                            $('#add_cliente').attr('disabled',false);
                    }
                });
            }
            function registrar_cliente()
            {
                var $inputs = $('#client-form :input');
                var values = {};
                $inputs.each(function() {
                    values[this.name] = $(this).val();
                });
                var data = JSON.stringify(values);
                console.log(data);
                $.ajax({
                    type: $("#client-form").attr('method'), // GET or POST
                    url: $("#client-form").attr('action'), // the file to call
                    data: data,
                    dataType: "json",
                    success: function(j){
                        console.log('Errores de Validacion');
                        var msg =JSON.stringify(j);
                        $("#msg").html(msg);
                        //$("#msg").html(msg);
                        //$("#cliente-form").modal('hide');
                    },
                    error: function(error){
                        alert("Ha ocurriso un error");
                    }
                });
            }
            $( document ).ready(function() {
                $('form .formset').formset();
                $(".chosen-select").chosen({no_results_text: "No se encontrÃ³ coincidencias con :", width: '100%' ,allow_single_deselect: true, });
                // Procesor AÃ±adir Cliente
{#                $("#client-form").submit(function(){#}
{#                    alert("Se esta guardando");#}
{#                    $.ajax({#}
{#                        type: $(this).attr('method'), // GET or POST#}
{#                        url: $(this).attr('action'), // the file to call#}
{#                        data: $(this).serialize(),#}
{#                        success: function(msg){#}
{#                            $("#thanks").html(msg)#}
{#                            $("#form-content").modal('hide');#}
{#                        },#}
{#                        error: function(error){#}
{#                            alert(error);#}
{#                        }#}
{#                    });#}
{#                });#}
{#                $('#client-form').on('submit', function(event){#}
{#                    event.preventDefault();#}
{#                    registrar_cliente();#}
{#                });#}
{#                $("#submit_cliente").click(function(){#}
{#                    var $inputs = $('#client-form :input');#}
{#                    var values = {};#}
{#                    $inputs.each(function() {#}
{#                        values[this.name] = $(this).val();#}
{#                    });#}
{#                    var data = JSON.stringify(values);#}
{#                    console.log(data);#}
{#                    $.ajax({#}
{#                        type: $("#client-form").attr('method'), // GET or POST#}
{#                        url: $("#client-form").attr('action'), // the file to call#}
{#                        data: data,#}
{#                        dataType: "json",#}
{#                        success: function(j){#}
{#                            console.log('Errores de Validacion');#}
{#                            var msg =JSON.stringify(j);#}
{#                            $("#msg").html(msg);#}
{#                            //$("#msg").html(msg);#}
{#                            //$("#cliente-form").modal('hide');#}
{#                        },#}
{#                        error: function(error){#}
{#                            alert("Ha ocurriso un error");#}
{#                        }#}
{#                    });#}
{#                });#}

            });
    </script>
{% endblock %}